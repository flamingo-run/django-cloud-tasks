<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://django-cloud-tasks.flamingo.codes/headers/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Header Propagation - Django Cloud Tasks</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Header Propagation";
        var mkdocs_page_input_path = "headers.md";
        var mkdocs_page_url = "/headers/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Django Cloud Tasks
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Getting Started</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../on_demand_tasks/">On-Demand Tasks</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../scheduled_tasks/">Scheduled Tasks</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../pubsub/">Pub/Sub</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Header Propagation</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#why-propagate-headers">Why Propagate Headers?</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#how-it-works">How It Works</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#configuration">Configuration</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1-middleware-setup">1. Middleware Setup</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2-settings-for-propagation">2. Settings for Propagation</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#accessing-propagated-headers-in-your-tasks">Accessing Propagated Headers in Your Tasks</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1-for-on-demand-task-and-scheduled-periodictask-tasks">1. For On-Demand (Task) and Scheduled (PeriodicTask) Tasks</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2-for-subscriber-tasks-subscribertask-pubsub">2. For Subscriber Tasks (SubscriberTask - Pub/Sub)</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../task_field/">TaskField (Model Field)</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Django Cloud Tasks</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Header Propagation</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="header-propagation">Header Propagation</h1>
<p>When you're dealing with asynchronous tasks, especially in a microservices or distributed environment, it's often crucial to carry over some context from the initial request that triggered the task. Header propagation allows you to do just that.</p>
<h2 id="why-propagate-headers">Why Propagate Headers?</h2>
<p>Common use cases include:</p>
<ul>
<li><strong>Distributed Tracing:</strong> To track a single logical operation as it flows through multiple services or asynchronous tasks. Headers like <code>traceparent</code> (as used by OpenTelemetry and others) or <code>X-Cloud-Trace-Context</code> (used by Google Cloud) are prime candidates.</li>
<li><strong>Tenant/User Context:</strong> If you have a multi-tenant application, you might want to propagate a <code>X-Tenant-ID</code> or <code>X-User-ID</code> so the task execution environment knows which tenant's data to operate on or which user initiated the action (primarily for logging or non-security-sensitive context).</li>
<li><strong>Feature Flags or A/B Testing Context:</strong> Propagating headers related to feature flags or A/B testing variants can ensure consistent behavior in asynchronous tasks.</li>
<li><strong>Client Information:</strong> Propagating <code>User-Agent</code> or custom client version headers (<code>X-Client-Version</code>) for logging and debugging purposes.</li>
</ul>
<h2 id="how-it-works">How It Works</h2>
<p>Header propagation relies on middleware to manage context:</p>
<ol>
<li><strong>Capture:</strong> The <code>HeadersContextMiddleware</code> intercepts incoming Django requests, extracts headers specified in <code>DJANGO_CLOUD_TASKS_PROPAGATED_HEADERS</code>, and stores them in a request-local context.</li>
<li><strong>Forwarding:</strong><ul>
<li><strong>Cloud Tasks (On-Demand/Scheduled):</strong> When a task is pushed, these stored headers are added as HTTP headers to the request Cloud Tasks (or Cloud Scheduler) makes to your application.</li>
<li><strong>Pub/Sub (PublisherTask):</strong> Propagated headers are embedded as a dictionary within the JSON payload of the Pub/Sub message, under the key defined by <code>DJANGO_CLOUD_TASKS_PROPAGATED_HEADERS_KEY</code>.</li>
</ul>
</li>
<li><strong>Retrieval:</strong><ul>
<li><strong>Cloud Tasks:</strong> Within your <code>Task</code> or <code>PeriodicTask</code>, <code>self._metadata.custom_headers</code> provides access to these propagated HTTP headers.</li>
<li><strong>Pub/Sub:</strong> The <code>PubSubHeadersMiddleware</code> extracts the embedded headers from the message payload when a push request for a <code>SubscriberTask</code> arrives. Your <code>SubscriberTask</code> then typically accesses them from the message <code>content</code> dictionary.</li>
</ul>
</li>
</ol>
<h2 id="configuration">Configuration</h2>
<h3 id="1-middleware-setup">1. Middleware Setup</h3>
<p>To enable header propagation, you <strong>must</strong> add the relevant middleware to your <code>settings.py</code>:</p>
<pre><code class="language-python">MIDDLEWARE = [
    # ... other django middleware ...
    'django_cloud_tasks.middleware.HeadersContextMiddleware',
    'django_cloud_tasks.middleware.PubSubHeadersMiddleware', # Important for subscriber tasks
    # ... other app middleware ...
]
</code></pre>
<ul>
<li><code>HeadersContextMiddleware</code>: Essential for capturing headers from incoming Django requests and making them available for propagation when new tasks are initiated. It also helps make headers available within a task's execution if they were propagated by Cloud Tasks.</li>
<li><code>PubSubHeadersMiddleware</code>: Specifically for tasks triggered by Pub/Sub push subscriptions. It extracts headers that were embedded in the Pub/Sub message body by a <code>PublisherTask</code> and loads them into the Django request context for the subscriber task handler.</li>
</ul>
<h3 id="2-settings-for-propagation">2. Settings for Propagation</h3>
<p>You configure which headers are propagated and how they are keyed in Pub/Sub messages via your Django <code>settings.py</code>:</p>
<ul>
<li>
<p><strong><code>DJANGO_CLOUD_TASKS_PROPAGATED_HEADERS</code></strong>: A list of HTTP header names that you want to capture and propagate. The matching from incoming requests is case-insensitive.</p>
<ul>
<li>Default: <code>["traceparent"]</code></li>
<li>Example:
    <code>python
    DJANGO_CLOUD_TASKS_PROPAGATED_HEADERS = [
        "traceparent",
        "X-Request-ID",
        "X-Tenant-ID",
        "X-User-ID",
        "Accept-Language",
    ]</code></li>
</ul>
</li>
<li>
<p><strong><code>DJANGO_CLOUD_TASKS_PROPAGATED_HEADERS_KEY</code></strong> (For Pub/Sub <code>PublisherTask</code> / <code>SubscriberTask</code>):
    This setting defines the key within the JSON message body where the dictionary of propagated headers will be stored by <code>PublisherTask</code> and read from by <code>PubSubHeadersMiddleware</code> (and your <code>SubscriberTask</code>).</p>
<ul>
<li>Default: <code>"_http_headers"</code></li>
<li>Example:
    <code>python
    DJANGO_CLOUD_TASKS_PROPAGATED_HEADERS_KEY = "_propagated_context_headers"</code></li>
</ul>
</li>
</ul>
<h2 id="accessing-propagated-headers-in-your-tasks">Accessing Propagated Headers in Your Tasks</h2>
<h3 id="1-for-on-demand-task-and-scheduled-periodictask-tasks">1. For On-Demand (<code>Task</code>) and Scheduled (<code>PeriodicTask</code>) Tasks</h3>
<p>These tasks are executed via an HTTP request from Google Cloud Tasks/Scheduler. Propagated headers are part of this request.</p>
<p>Access them via <code>self._metadata.custom_headers</code> in your task's <code>run</code> method. This dictionary holds headers from the task execution request that were listed in <code>DJANGO_CLOUD_TASKS_PROPAGATED_HEADERS</code>.</p>
<pre><code class="language-python">from django_cloud_tasks.tasks import Task

class ProcessDataWithTraceTask(Task):
    def run(self, data_id: int):
        # Headers in custom_headers are typically lowercased
        trace_id = self._metadata.custom_headers.get(&quot;traceparent&quot;)
        tenant_id = self._metadata.custom_headers.get(&quot;x-tenant-id&quot;)

        print(f&quot;Executing for data ID: {data_id}, Trace: {trace_id}, Tenant: {tenant_id}&quot;)
        # ... your task logic ...
</code></pre>
<h3 id="2-for-subscriber-tasks-subscribertask-pubsub">2. For Subscriber Tasks (<code>SubscriberTask</code> - Pub/Sub)</h3>
<p>With <code>PublisherTask</code>, headers are embedded in the Pub/Sub message <em>body</em>. Your <code>SubscriberTask</code> accesses them from the <code>content</code> dictionary using the <code>DJANGO_CLOUD_TASKS_PROPAGATED_HEADERS_KEY</code>.</p>
<pre><code class="language-python">from django_cloud_tasks.tasks import SubscriberTask
from django_cloud_tasks.tasks.helpers import get_app

class AuditLogSubscriber(SubscriberTask):
    @classmethod
    def topic_name(cls) -&gt; str:
        return &quot;user-activity-events&quot;

    def run(self, content: dict, attributes: dict[str, str] | None = None):
        headers_key = get_app().propagated_headers_key
        propagated_headers = content.get(headers_key, {})

        user_id = propagated_headers.get(&quot;X-User-ID&quot;) # Case here matches what was put into the dict
        request_id = propagated_headers.get(&quot;X-Request-ID&quot;)

        # original_event_payload might exclude the headers for clarity if needed
        # original_event_payload = {k: v for k, v in content.items() if k != headers_key}

        print(f&quot;Audit event: {content}, User: {user_id}, Request: {request_id}&quot;)
        # ... audit logging ...
</code></pre>
<p>By correctly setting up the middleware and configurations, header propagation provides valuable context for your asynchronous operations. </p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../pubsub/" class="btn btn-neutral float-left" title="Pub/Sub"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../task_field/" class="btn btn-neutral float-right" title="TaskField (Model Field)">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../pubsub/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../task_field/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
